<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            padding: 0;
            margin: 0;
            border: none;
            width: 100%;
            font-size: 12px;
            font-size: 1em;
            background-color: #ffffff;
            color: rgb(0, 0, 0);
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <!--<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet">-->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&family=Titillium+Web:wght@300&display=swap"
        rel="stylesheet">



</head>

<body>
</body>

<script async type=module>
        import URL from "/@cl/uri/";
        import spark from "/@cl/spark/";
        
        let ACTIVE = true, SLOW_POOL = true, cache = [];

        class TestRunner{

           static async complete_test(results, test_id){
                (await (new URL("/test_rigs/resolve/")).submitJSON({
                    results,
                    test_id
                }))
            }
            
            constructor(test, test_id){

                if(cache.length > 0){
                    const cached = cache.pop(); 
                    cached.load(test, test_id);
                    return cached;
                }

                this.iframe = document.createElement("iframe");
                
                this.iframe.src = "/components/iframe.html";
                console.log(this.iframe)
                this.loaded = new Promise(
                    res=>{
                        this.iframe
                        .addEventListener("load", ()=>res())
                    }
                )
                document.body.appendChild(this.iframe);
                this.load(test, test_id);
            }

            clear(){
                this.id  = -1;
                this.test = null;
                cache.push(this)
            }

            async load(test, test_id){
                
                await this.loaded;
                
                this.COMPLETED = false;
                
                const pending_results = await this.iframe.contentWindow.runTest(
                    Object.assign(test, {test_id})
                );

                console.log(pending_results)

                await TestRunner.complete_test(
                    pending_results, test_id
                )

                this.COMPLETED = true;

            }
        }

        async function start(){

            const globals = (await (new URL("/globals/acquire/")).fetchJSON());

            let falloff = 2;

            await spark.sleep(500);

            let active_tests = [];

            while(SLOW_POOL){

                console.log("POLLING")

                if(!ACTIVE){

                    const {NO_TESTS_NEED_TO_WAIT, test_id, test} = (await (new URL("/test_rigs/acquire/")).fetchJSON());

                    if(!NO_TESTS_NEED_TO_WAIT){
                        active_tests.push(new TestRunner( test, test_id));
                        ACTIVE = true;
                    }
                }

                await spark.sleep(50)

                while(ACTIVE){   

                    for(let i = 0; i < active_tests.length; i++){
                        
                        const test_runner = active_tests[i];

                        if(test_runner.COMPLETED){
                            active_tests.splice(i,1);
                            i--;
                            test_runner.clear();
                        };
                    }

                    if(active_tests.length == 0)
                        ACTIVE == false;

                    const {NO_TESTS_NEED_TO_WAIT, test_id, test} = (await (new URL("/test_rigs/acquire/")).fetchJSON());
                    
                    if(!NO_TESTS_NEED_TO_WAIT){
                        active_tests.push(new TestRunner(test, test_id));
                        await spark.sleep(2);
                        falloff = 2;
                    }else if(active_tests.length > 0) {
                        await spark.sleep(50);
                    }else {
                        await spark.sleep(Math.min(falloff += (falloff * 0.5)), 500);
                    }
                }

                await spark.sleep(200)
            }
        }

        start();

    </script>

</html>
