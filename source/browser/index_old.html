<!DOCTYPE html>
<html>
    <head>
        <style>
            body{
                padding: 0;
                margin: 0;
                border: none;
                width: 100%;
                font-size: 12px;
                font-size: 1em;
                background-color: #ffffff;
                color: rgb(0, 0, 0);
            }
        </style>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
        <!--<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet">-->
        <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&family=Titillium+Web:wght@300&display=swap" rel="stylesheet">



    </head>
    <body>
    </body>
    
    <script async type=module>
        //  const d = window.open("./0/", "Test 1");
        import {cfw} from "/@cl/cfw/";
        import URL from "/@cl/url/";
        import wick from "/@cl/wick/";
        import spark from "/@cl/spark/";
      //  import glow from "/@candlelib/glow";
        

        let ACTIVE = true, SLOW_POOL = true;

        async function start(){


           async function complete_test(result, test_id){    
      
                result.errors = result.errors.map(e=>Object.assign({}, e))

                const {completed} = (await (new URL("/test_rigs/resolve/")).submitJSON({
                    result,
                    test_id
                }))

                if(completed)  ACTIVE = false;
            }
            
           await wick.setPresets({
               options:{
                    //GENERATE_SOURCE_MAPS:true,
                    REMOVE_DEBUGGER_STATEMENTS:false  },
                api: {

                    complete_test,

                    URL
                },
                models: {
                    meta:{tests : wick.objects.Observable([])}
                }
            })

            const test_runner_comp_data = await wick("/components/testing/test_runner.wick");

            document.body.appendChild((new test_runner_comp_data.class_with_integrated_css).ele);

            const globals = (await (new URL("/globals/acquire/")).fetchJSON());

            let falloff = 2;

            while(SLOW_POOL){

                if(!ACTIVE){

                    const {NO_TESTS, test_id, test} = (await (new URL("/test_rigs/acquire/")).fetchJSON());

                    if(!NO_TESTS){
                        wick.rt.presets.models.meta.tests.length = 0;
                        wick.rt.presets.models.meta.tests.push(Object.assign(test, {test_id}))
                        ACTIVE= true;
                    }
                }

                await spark.sleep(100)
            
                while(ACTIVE){        
                    const {NO_TESTS, test_id, test} = (await (new URL("/test_rigs/acquire/")).fetchJSON());
                    
                    if(!NO_TESTS){
                        wick.rt.presets.models.meta.tests.push(Object.assign(test, {test_id}))
                        await spark.sleep(2);
                        falloff = 2;
                    }else {
                        await spark.sleep(falloff += (falloff * 0.5));
                    }
                }

                await spark.sleep(1000)
            }
        }

        start();

    </script>
</html>